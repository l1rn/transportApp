name: Automated API tests using Postman CLI

on: push

jobs:
  automated-api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5 
    defaults:
      run: 
        working-directory: './backend'
    
    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: --health-cmd "redis-cli ping"
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build
        run: |
          ./mvnw clean package -DskipTests -P dev 
          
      - name: Start 
        run: | 
          java -jar target/*.jar &
          sleep 15
          
      - name: Check server health
        run: |
          until curl -s -s http://localhost:8080/api/health; do
            sleep 1
          done

      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh

      - name: Login to Postman CLI
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Run Authentication API tests
        run: |
          postman collection run "43572409-4992a297-2320-4638-960c-d7513cfb6320" -e "43572409-1a6ea748-5deb-4ace-bf6c-ba9d68ca130a"
      
      - name: Run Routes API tests
        run: |
          postman collection run "43572409-84bf2f90-654f-43fe-b0d7-8881a65a3e21" -e "43572409-1a6ea748-5deb-4ace-bf6c-ba9d68ca130a"